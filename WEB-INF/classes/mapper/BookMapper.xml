<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qcacg.mapper.BookMapper">

    <resultMap id="BookResultMap" type="com.qcacg.entity.book.BookCustom">
        <id column="bookId" property="bookId"/>
        <result column="userId" property="userId"/>
        <result column="bookName" property="bookName"/>
        <result column="sort" property="sort"/>
        <result column="bookIntroduction" property="bookIntroduction"/>
        <result column="bookUpdate" property="bookUpdate"/>
        <result column="bookCoverImage" property="bookCoverImage"/>
        <result column="bookWordCount" property="bookWordCount"/>
        <result column="bookStatus" property="bookStatus"/>
        <result column="bookHit" property="bookHit"/>
        <result column="bookCollect" property="bookCollect"/>
        <result column="bookCopperCoins" property="bookCopperCoins"/>
        <association property="userEntity" javaType="com.qcacg.entity.UserEntity">
            <id column="userId" property="userId"/>
            <result column="userName" property="userName"/>
            <result column="information" property="information"/>
            <result column="userHead" property="userHead"/>
        </association>
    </resultMap>

    <!-- 查找所有未被推荐的书 -->
    <select id="findAllBook" resultMap="BookResultMap">
SELECT
	wor_book.BookId AS bookId,
	wor_book.UserId AS userId,
	wor_book.BookName AS bookName,
	wor_book.Sort AS sort,
	wor_book.BookIntroduction AS bookIntroduction,
	wor_book.BookUpdate AS bookUpdate,
	wor_book.BookCoverImage AS bookCoverImage,
	wor_book.BookWordCount AS bookWordCount,
	wor_book.BookStatus AS bookStatus,
	wor_book.BookHit AS bookHit,
	wor_book.BookCollect AS bookCollect,
	wor_book.BookCopperCoins AS bookCopperCoins,
	wor_book.BookSilverCoins AS bookSilverCoins,
	sys_user.UserId AS userId,
	sys_user.UserName AS userName,
	sys_user.Information AS information,
	sys_user.UserHead AS userHead
FROM
	wor_book
LEFT JOIN sys_user ON wor_book.UserId = sys_user.UserId
WHERE
    wor_book.IsRecommended = '0'
    AND
    wor_book.BookStatus = '0'
    </select>

    <!-- 查找被推荐的书，并且在主页显示 -->
    <select id="findBookByIsRecom" resultMap="BookResultMap">
SELECT
	wor_book.BookId AS bookId,
	wor_book.UserId AS userId,
	wor_book.BookName AS bookName,
	wor_book.Sort AS sort,
	wor_book.BookIntroduction AS bookIntroduction,
	wor_book.BookUpdate AS bookUpdate,
	wor_book.BookCoverImage AS bookCoverImage,
	wor_book.BookWordCount AS bookWordCount,
	wor_book.BookStatus AS bookStatus,
	wor_book.BookHit AS bookHit,
	wor_book.BookCollect AS bookCollect,
	wor_book.BookCopperCoins AS bookCopperCoins,
	wor_book.BookSilverCoins AS bookSilverCoins,
	sys_user.UserId AS userId,
	sys_user.UserName AS userName,
	sys_user.Information AS information,
	sys_user.UserHead AS userHead
FROM
	wor_book
LEFT JOIN sys_user ON wor_book.UserId = sys_user.UserId
WHERE
    wor_book.BookStatus = '0'
    AND
    wor_book.IsRecommended = '1'
    AND
    wor_book.BookOnIndex != '0'
    limit 0, 6
    </select>

    <!-- 查找90天内创建的新书，并且未被推荐 -->
    <select id="findBookByCreateTime" resultMap="BookResultMap">
SELECT
    wor_book.BookId AS bookId,
	wor_book.UserId AS userId,
	wor_book.BookName AS bookName,
	wor_book.Sort AS sort,
	wor_book.BookIntroduction AS bookIntroduction,
	wor_book.BookUpdate AS bookUpdate,
	wor_book.BookCoverImage AS bookCoverImage,
	wor_book.BookWordCount AS bookWordCount,
	wor_book.BookStatus AS bookStatus,
	wor_book.BookHit AS bookHit,
	wor_book.BookCollect AS bookCollect,
	wor_book.BookCopperCoins AS bookCopperCoins,
	wor_book.BookSilverCoins AS bookSilverCoins,
	sys_user.UserId AS userId,
	sys_user.UserName AS userName,
	sys_user.Information AS information,
	sys_user.UserHead AS userHead
FROM
	wor_book
LEFT JOIN sys_user ON wor_book.UserId = sys_user.UserId
WHERE
    wor_book.BookStatus = '0'
AND
    wor_book.IsRecommended = '0'
AND
    DATEDIFF(SYSDATE(),wor_book.BookCreateTime) BETWEEN 0 AND 90

<!-- DATEDIFF(SYSDATE(),wor_book.BookCreateTime) -->
    </select>


    <delete id="deleteUserByTelephone" parameterType="String">
        DELETE FROM sys_user WHERE sys_user.Telephone = #{sys_user.Telephone}
    </delete>

    <select id="findBookByBookName" resultType="com.qcacg.entity.BookEntity" parameterType="String">
        SELECT
          wor_book.BookId,
          wor_book.BookName
        FROM
          wor_book
        WHERE
          wor_book.BookName = #{wor_book.BookName}
    </select>

    <select id="findBookByUserId" resultType="com.qcacg.entity.BookEntity" parameterType="java.lang.Long">
SELECT
wor_book.BookId,
wor_book.UserId,
wor_book.BookName,
wor_book.BookCoverImage,
wor_book.UserId,
wor_book.Sort,
wor_book.BookIntroduction,
wor_book.BookUpdate,
wor_book.BookWordCount,
wor_book.BookStatus,
wor_book.BookHit,
wor_book.BookCollect,
wor_book.BookCopperCoins,
wor_book.BookSilverCoins
FROM
wor_book
WHERE
wor_book.UserId = #{wor_book.UserId}
ORDER BY
wor_book.BookUpdate DESC

    </select>

    <resultMap id="bookInfoResult" type="com.qcacg.entity.book.BookInfoEntity">
        <id column="bookId" property="bookId"/>
        <result column="userId" property="userId"/>
        <result column="bookName" property="bookName"/>
        <result column="sort" property="sort"/>
        <result column="bookIntroduction" property="bookIntroduction"/>
        <result column="bookUpdate" property="bookUpdate"/>
        <result column="bookCoverImage" property="bookCoverImage"/>
        <result column="bookWordCount" property="bookWordCount"/>
        <result column="bookStatus" property="bookStatus"/>
        <result column="bookHit" property="bookHit"/>
        <result column="bookCollect" property="bookCollect"/>
        <result column="bookCopperCoins" property="bookCopperCoins"/>
        <result column="userName" property="author"/>
        <result column="userHead" property="userHeadImg"/>
        <association property="volumeEntity" javaType="com.qcacg.entity.VolumeEntity">
            <id column="volumeId" property="volumeId"/>
            <result column="volumeName" property="volumeName"/>
        </association>
    </resultMap>

    <select id="findBookByBookUpDate" resultMap="bookInfoResult" >
      SELECT
wor_book.BookId AS bookId,
wor_book.UserId AS userId,
wor_book.BookName AS bookName,
wor_book.Sort AS sort,
wor_book.BookIntroduction AS bookIntroduction,
wor_book.BookUpdate AS bookUpdate,
wor_book.BookCoverImage AS bookCoverImage,
wor_book.BookWordCount AS bookWordCount,
wor_book.BookStatus AS bookStatus,
wor_book.BookHit AS bookHit,
wor_book.BookCollect AS bookCollect,
wor_book.BookCopperCoins AS bookCopperCoins,
wor_book.BookSilverCoins AS bookSilverCoins,
sys_user.UserId AS userId,
sys_user.UserName AS userName,
sys_user.Information AS information,
sys_user.UserHead AS userHead,
volumeView.id AS volumeId,
volumeView.VolumeName AS volumeName
    FROM
    wor_book
    LEFT JOIN sys_user ON wor_book.UserId = sys_user.UserId
    , (SELECT MAX(VolumeId) as id, VolumeName, BookId
        from wor_volume WHERE VolumeStatus = 0 GROUP BY BookId) volumeView
    WHERE
    volumeView.BookId = wor_book.BookId
    AND
    wor_book.BookStatus = '0'
    ORDER BY
    wor_book.BookUpdate DESC
    </select>

    <select id="findBookByBookCopperCoins" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
wor_book.UserId,
wor_book.BookName,
wor_book.Sort,
wor_book.BookIntroduction,
wor_book.BookUpdate,
wor_book.BookCoverImage,
wor_book.BookWordCount,
wor_book.BookStatus,
wor_book.BookHit,
wor_book.BookCollect,
wor_book.BookCopperCoins,
wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.BookCopperCoins DESC
    </select>

    <select id="WeekBookByBookCopperCoins" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.EveryWeekCopperCoins DESC
    </select>

    <select id="MonthBookByBookCopperCoins" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.EveryMonthCopperCoins DESC
    </select>

    <select id="findBookByBookHit" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.BookHit DESC
    </select>


    <select id="WeekBookByBookHit" resultType="com.qcacg.entity.BookEntity" >
    SELECT
    wor_book.BookId,
    wor_book.UserId,
    wor_book.BookName,
    wor_book.Sort,
    wor_book.BookIntroduction,
    wor_book.BookUpdate,
    wor_book.BookCoverImage,
    wor_book.BookWordCount,
    wor_book.BookStatus,
    wor_book.BookHit,
    wor_book.BookCollect,
    wor_book.BookCopperCoins,
    wor_book.BookSilverCoins
    FROM
    wor_book
    WHERE
    wor_book.BookStatus = '0'
    ORDER BY
    wor_book.EveryWeekHit DESC
    </select>

    <select id="MonthBookByBookHit" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.EveryMonthHit DESC
    </select>

    <select id="findBookByBookWordCount" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.BookWordCount DESC
    </select>

    <select id="WeekBookByBookWordCount" resultType="com.qcacg.entity.BookEntity" >
    SELECT
    wor_book.BookId,
    wor_book.UserId,
    wor_book.BookName,
    wor_book.Sort,
    wor_book.BookIntroduction,
    wor_book.BookUpdate,
    wor_book.BookCoverImage,
    wor_book.BookWordCount,
    wor_book.BookStatus,
    wor_book.BookHit,
    wor_book.BookCollect,
    wor_book.BookCopperCoins,
    wor_book.BookSilverCoins
    FROM
    wor_book
    WHERE
    wor_book.BookStatus = '0'
    ORDER BY
    wor_book.EveryWeekWordCount DESC
    </select>

    <select id="MonthBookByBookWordCount" resultType="com.qcacg.entity.BookEntity" >
        SELECT
        wor_book.BookId,
        wor_book.UserId,
        wor_book.BookName,
        wor_book.Sort,
        wor_book.BookIntroduction,
        wor_book.BookUpdate,
        wor_book.BookCoverImage,
        wor_book.BookWordCount,
        wor_book.BookStatus,
        wor_book.BookHit,
        wor_book.BookCollect,
        wor_book.BookCopperCoins,
        wor_book.BookSilverCoins
        FROM
        wor_book
        WHERE
        wor_book.BookStatus = '0'
        ORDER BY
        wor_book.EveryMonthWordCount DESC
    </select>

    <select id="queryBookForCheck" resultType="com.qcacg.entity.BookEntity">
        SELECT
wor_book.BookId,
wor_book.UserId,
wor_book.BookName,
wor_book.Sort,
wor_book.BookIntroduction,
wor_book.BookUpdate,
wor_book.BookCoverImage,
wor_book.BookWordCount,
wor_book.BookStatus,
wor_book.BookHit,
wor_book.BookCollect,
wor_book.BookCopperCoins,
wor_book.BookSilverCoins
FROM
wor_book
WHERE
wor_book.BookStatus = '2'
ORDER BY
wor_book.BookUpdate ASC

    </select>

    <select id="SearchBookByKeyWord" resultType="com.qcacg.entity.BookEntity" parameterType="java.lang.String">
    SELECT
    wor_book.BookId,
    wor_book.UserId,
    wor_book.BookName,
    wor_book.Sort,
    wor_book.BookIntroduction,
    wor_book.BookUpdate,
    wor_book.BookCoverImage,
    wor_book.BookWordCount,
    wor_book.BookStatus,
    wor_book.BookHit,
    wor_book.BookCollect,
    wor_book.BookCopperCoins,
    wor_book.BookSilverCoins,
    wor_book.WeekWordCount,
    wor_book.WeekHit,
    wor_book.WeekCopperCoins,
    wor_book.MonthWordCount,
    wor_book.MonthHit,
    wor_book.MonthCopperCoins,
    wor_book.EveryWeekWordCount,
    wor_book.EveryWeekHit,
    wor_book.EveryWeekCopperCoins,
    wor_book.EveryMonthWordCount,
    wor_book.EveryMonthHit,
    wor_book.EveryMonthCopperCoins
    FROM
    wor_book,
    sys_user
    WHERE
    wor_book.BookName LIKE CONCAT('%',#{KeyWord},'%')
    OR sys_user.UserName LIKE CONCAT('%',#{KeyWord},'%')
    AND wor_book.UserId = sys_user.UserId
    AND wor_book.BookStatus = '0'
    GROUP BY
    wor_book.BookId
    </select>

    <insert id="insertBook" parameterType="com.qcacg.entity.BookEntity" useGeneratedKeys="true" keyProperty="bookId">
        <selectKey keyProperty="bookId" resultType="java.lang.Long" order="AFTER">
            SELECT LAST_INSERT_ID() as bookId
        </selectKey>
        INSERT INTO wor_book (bookId,userId,bookName,sort,bookIntroduction,bookCoverImage, wor_book.BookCreateTime)
        VALUES( #{bookId,jdbcType=BIGINT},#{userId,jdbcType=BIGINT},#{bookName,jdbcType=VARCHAR},#{sort,jdbcType=VARCHAR},#{bookIntroduction,jdbcType=VARCHAR},#{bookCoverImage,jdbcType=VARCHAR}, #{bookCreateTime} )
    </insert>

    <update id="updateBook" parameterType="com.qcacg.entity.BookEntity">
        UPDATE wor_book SET bookName=#{bookName},sort=#{sort},bookIntroduction=#{bookIntroduction},bookCoverImage=#{bookCoverImage} WHERE bookId=#{bookId}
    </update>

    <update id="userUpdateBookStatus" parameterType="java.lang.Long">
        UPDATE wor_book SET bookStatus= '2' WHERE bookId=#{bookId}
    </update>

    <update id="adminUpdateBookStatus" parameterType="java.lang.Long">
        UPDATE wor_book SET bookStatus= '1' WHERE bookId=#{bookId}
    </update>

    <update id="batchUpdateBookStatus" parameterType="java.util.List">
        UPDATE wor_book SET wor_book.BookStatus = '2'
        WHERE wor_book.BookId IN
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")" >
            #{item}
        </foreach>
    </update>

    <update id="batchUpdateBookStatus2" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" open="" close="" separator=";">
            UPDATE wor_book SET wor_book.BookStatus = '2'
            WHERE wor_book.BookId = #{item}
        </foreach>
    </update>

    <delete id="deleteBookByBookId" parameterType="java.lang.Long">
        DELETE wor_book, wor_bookcollect,
        wor_bookcopper, wor_bookhit,
        wor_booksilver, wor_book_booktype,
        wor_volume
        FROM
        wor_book, wor_bookcollect,
        wor_bookcopper, wor_bookhit,
        wor_booksilver, wor_book_booktype,
        wor_volume
        WHERE
          wor_book.BookId = wor_bookcollect.BookId = wor_bookcopper.BookId = wor_bookhit.BookId
          = wor_booksilver.BookId = wor_book_booktype.BookId = wor_volume.BookId
        AND
          wor_book.BookId = #{bookId}
    </delete>
    <delete id="batchDeleteBookByBookId" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" open="" close="" separator=";">
            DELETE wor_book, wor_bookcollect,
            wor_bookcopper, wor_bookhit,
            wor_booksilver, wor_book_booktype,
            wor_volume
            FROM
            wor_book, wor_bookcollect,
            wor_bookcopper, wor_bookhit,
            wor_booksilver, wor_book_booktype,
            wor_volume
            WHERE
            wor_book.BookId = wor_bookcollect.BookId = wor_bookcopper.BookId = wor_bookhit.BookId
            = wor_booksilver.BookId = wor_book_booktype.BookId = wor_volume.BookId
            AND
            wor_book.BookId = #{item}
        </foreach>
    </delete>
</mapper>